# Node.js и MongoDB

## Начало работы с MongoDB

Наиболее популярной системой управления базами данных для Node.js на данный момент является MongoDB. Для работы с этой платформой прежде всего необходимо установить сам сервер MongoDB. Подробнее как это сделать, описывается здесь. 
Кроме самого сервера Mongo для взаимодействия с Node.js нам необходим драйвер.

При подключении и взаимодействии с бд в MongoDB можно выделить следующие этапы:

Итак, создадим новый проект. Для этого определим новый каталог, который будет называться **mongoapp**.  Далее определим в этом каталоге новый файл **package.json**:

```js
{
  "name": "mongoapp",
  "version": "1.0.0",
  "dependencies": {
      "express": "^4.16.0",
      "body-parser": "^1.18.0",
      "mongodb": "^3.1.0"
    }
}
```

В данном случае последняя зависимость - "mongodb" как раз и представляет драйвер. Всю необходимую справочную информацию конкретно по данному драйверу 
можно найти на https://mongodb.github.io/node-mongodb-native/.

Далее перейдем к этому каталогу в командной строке/терминале и для добавления всех нужных пакетов выполним команду:

```

```

### Подключение к базе данных

Ключевым классом для работы с MongoDB является класс **MongoClient**, и через него будет идти все взаимодействия с хранилищем данных. 
Соответственно вначале мы должны получить MongoClient:

```js
const MongoClient = require("mongodb").MongoClient;
```

Для подключения к серверу mongodb применяется метод **connect()**:

```js
const MongoClient = require("mongodb").MongoClient;

// создаем объект MongoClient и передаем ему строку подключения
const mongoClient = new MongoClient("mongodb://localhost:27017/", { useNewUrlParser: true });
mongoClient.connect(function(err, client){

    if(err){
        return console.log(err);
    }
    // взаимодействие с базой данных
    client.close();
});
```

Вначале создается объект MongoClient. Для этого в его конструктор передается два параметра. Первый параметр - это 
адрес сервера. В качестве протокола адреса устанавливается "mongodb://". На локальной машине адресом будет localhost, после 
которого указывается номер порта. По умолчанию номер порта 27017.

Второй парамтр - это необязательный объкт конфигурации. MongoDb постоянно развивается. В данном случае применяется объект 
конфигурации, который имеет свойство `useNewUrlParser: true` - оно указывает инфраструктуре mongodb, что надо использовать новый парсел адреса сервера.

Далее с помощью метода connect происходит подключение к серверу. В качестве параметра метод принимает функцию обратного вызова, 
которая срабатывает при установке подключения. Это функция принимает два параметра: 
**err** (возникшая ошибка при установке соединения) и **client** (ссылка на подключенный к серверу клиент).

Если при подключении возникли ошибки, то мы можем использовать значение err для получения ошибки.

Если же ошибки нет, то мы можем взаимодействовать с сервером через объект **client**.

В конце завершения работы с бд нам надо закрыть соединение с помощью метода **client.close()**.

### База данных, коллекции и документы

Получив объект подлюченного клиента, мы можем обращаться к базе данных на сервере. Для этого используется метод

```js
client.db("название_бд");
```

В качестве параметра в метод передается название базы данных, к которой мы хотим подключиться.

База данных в MongoDB не имеет таблиц. Вместо этого все данные попадают в коллекции. И в рамках node.js для взаимодействия 
с базой данных (добавления, удаления, чтения данных) нам потребуется получить объект коллекции. Для этого применяется метод **db.collection("название_коллекции")**, 
в который передается название коллекции.

В отличие от таблиц в реляционных системах, где все данные хранятся в виде строк, в коллекциях в MongoDB данные хранятся в виде документов. Например, 
добавим в базу данных один документ. Для этого определим в каталоге проекта следующий файл **app.js**:

```js
const MongoClient = require("mongodb").MongoClient;
  
const url = "mongodb://localhost:27017/";
const mongoClient = new MongoClient(url, { useNewUrlParser: true });

mongoClient.connect(function(err, client){
     
    const db = client.db("usersdb");
    const collection = db.collection("users");
    let user = {name: "Tom", age: 23};
    collection.insertOne(user, function(err, result){
         
        if(err){ 
            return console.log(err);
        }
        console.log(result.ops);
        client.close();
    });
});
```

В качестве базы данных здесь используется "usersdb". При этом не важно, что по умолчанию на сервере MongoDB нет подобной базы данных. При первом к ней обращении 
сервер автоматически ее создаст.

После подключения мы обращаемся к коллекции "users":

```js
const collection = db.collection("users");
```

Опять же неважно, что такой коллекции по умолчанию нет в бд usersdb, она также будет создана при первом обращении.

Получив коллекцию, мы можем использовать ее методы. В данном случае для добавления одного документа - объекта user применяется метод **insertOne()**. 
Этот метод имеет два параметра - сам добавляемый объект и функцию обратного вызова, которая выполняется после добавления. В этой функции применяются два 
параметра: **err** (ошибка, которая может возникнуть при операции) и **result** (результат операции - добавленный объект).

В функции обратного вызова инспектируется добавленный объект с помощью свойства **result.ops**. Причем это уже не просто объект 
user, а объект, который получен обратно из базы данных и который содержит идентификатор, установленный при добавлении.

Теперь перейдем на жестком диске к каталогу, в который установлена mongodb, а в этом каталоге перейдем к папке **bin**:

![MongoDB в Node.js](https://metanit.com/web/nodejs/pics/7.1.png)

Запустим сервер mongodb, который находится в этом каталоге и который представляет собой консольную программу **mongod**.

![Запуск MongoDB в Node.js](https://metanit.com/web/nodejs/pics/7.2.png)

Затем запустим наш файл app.js:

![Документы MongoDB в Node.js](https://metanit.com/web/nodejs/pics/7.3.png)

Как мы видим, кроме начальных свойств здесь документ еще имеет дополнительное свойство **_id** - это уникальный идентификатор документа, 
который присваивается сервером при добавлении.

